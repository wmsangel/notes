# Развёртывание на хостинг (без npm на сервере)

Есть три способа выложить приложение так, чтобы **на самом хостинге не запускать npm**.

---

## 1. Docker (рекомендуется) — на сервере только `docker run`

На своей машине один раз собираете образ, везёте его на хостинг и запускаете контейнер. На сервере **не нужны Node.js и npm**.

### Сборка образа (у себя или в CI)

```bash
# В корне проекта
docker build -t notes-app .
```

### Запуск на сервере

Нужны: **Docker** и **MySQL** (отдельный сервер или облачная БД).

```bash
docker run -d \
  --name notes \
  -p 3000:3000 \
  -e NODE_ENV=production \
  -e DB_HOST=ваш-mysql-хост \
  -e DB_PORT=3306 \
  -e DB_USER=пользователь \
  -e DB_PASSWORD=пароль \
  -e DB_NAME=имя_базы \
  notes-app
```

- Сайт: `http://ваш-сервер:3000`
- API: `http://ваш-сервер:3000/api`
- Фронтенд и бэкенд обслуживаются одним процессом, npm на сервере не используется.

Миграции БД один раз выполните так (подставьте свои параметры):

```bash
# Локально или на сервере, с доступом к MySQL
mysql -h DB_HOST -u DB_USER -p DB_NAME < database/schema.sql
# затем
node backend/run-migrations.js
```

Либо настройте одноразовый контейнер/скрипт, который подключается к той же БД и запускает миграции.

---

## 2. Один сервер (Node.js на хостинге, но npm только при деплое)

Собираете фронтенд **у себя**, заливаете на хостинг уже готовую папку `backend` (в ней лежит `public` со статикой). На сервере запускаете только `node server.js`.

### Шаг 1 — сборка у себя (один раз перед заливкой)

```bash
# В корне проекта
sh scripts/build-for-production.sh
```

Скрипт соберёт фронтенд и скопирует его в `backend/public`.

### Шаг 2 — что заливать на хостинг

Заливаете папку **backend** целиком (внутри уже есть `public` со статикой):

- все файлы бэкенда;
- папка `public` (собранный фронтенд);
- `node_modules` можно не заливать, если на хостинге один раз выполните `npm install --production` в папке `backend`.

### Шаг 3 — запуск на сервере

```bash
cd backend
npm install --production   # один раз
NODE_ENV=production node server.js
```

Или через PM2:

```bash
cd backend
npm install --production
NODE_ENV=production pm2 start server.js --name notes
```

Порт по умолчанию: 3000. В браузере открываете `http://ваш-домен:3000`.

Так вы **не запускаете npm для сборки** на хостинге — только один раз `npm install` для установки зависимостей; дальше только `node server.js`.

---

## 3. PaaS (Railway, Render, Fly.io и т.п.) — npm выполняет хостинг

Регистрируете проект из Git-репозитория. Хостинг сам делает `npm install` и `npm start` при каждом деплое. **Вы npm на сервере не запускаете** — только пушите код.

1. Подключите репозиторий к сервису.
2. Укажите:
   - **Root / Build directory:** корень репозитория (или папка с backend, если настроен монорепо).
   - **Build:**  
     `sh scripts/build-for-production.sh` (если есть в репо) или отдельно сборка фронта и копирование в `backend/public`.  
     Либо настройте в панели: сначала сборка фронтенда с `VITE_API_URL=/api`, затем копирование `frontend/dist` в `backend/public`.
   - **Start:**  
     `cd backend && NODE_ENV=production node server.js`
3. Добавьте переменные окружения: `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, при необходимости `PORT`.
4. Базу MySQL создайте в том же PaaS или в облачном MySQL (PlanetScale, Railway DB и т.д.) и подставьте данные в переменные.

После этого деплой = push в Git; сборка и запуск выполняет хостинг, без ручного запуска npm у себя на сервере.

---

## 4. Railway (пошагово)

Railway — PaaS с бесплатным тиром ($1 кредитов/мес), деплой из GitHub, MySQL в один клик. **Никакого своего сервера и SSH.**

### 1. Регистрация и проект

1. Зайдите на [railway.app](https://railway.app), войдите через **GitHub**.
2. **New Project** → **Deploy from GitHub repo** — выберите репозиторий с этим проектом.
3. Railway создаст сервис из репо. Пока без БД.

### 2. Добавить MySQL

1. В том же проекте нажмите **+ New** → **Database** → **Add MySQL**.
2. Railway создаст БД и покажет переменные (хост, пользователь, пароль, база). Они автоматически подтянутся в сервис приложения, если включена привязка (см. ниже).

### 3. Настроить сборку и запуск

В настройках **сервиса приложения** (не БД):

- **Settings** → **Build**:
  - **Build Command:** `npm run build`
  - **Root Directory:** оставьте пустым (корень репо).
- **Settings** → **Deploy**:
  - **Start Command:** `npm start`
  - **Watch Paths:** можно не менять.

В корне репо уже есть **package.json** с командами:
- `npm run build` — ставит зависимости, собирает фронт, копирует в `backend/public`, ставит зависимости бэкенда.
- `npm start` — запускает `node server.js` в `backend/`.

### 4. Переменные окружения (БД)

Railway при добавлении MySQL подставляет переменные. Бэкенд умеет читать:

- либо **одну строку** `DATABASE_URL` или `MYSQL_URL` (формат `mysql://user:password@host:port/database`);
- либо по отдельности: `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`.

Если Railway даёт одну ссылку (например `MYSQL_URL`) — ничего дополнительно указывать не нужно. Если даёт отдельные поля — в сервисе приложения в **Variables** добавьте:

- `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, при необходимости `DB_PORT`.

Переменную **PORT** Railway задаёт сам, бэкенд её уже использует.

### 5. Домен

В **Settings** → **Networking** → **Generate Domain** — Railway выдаст поддомен вида `ваш-сервис.up.railway.app`. Свой домен можно привязать там же позже.

### 6. Миграции БД (один раз)

После первого деплоя база пустая. Миграции нужно выполнить один раз:

- **Вариант А:** локально — в `.env` указать те же `DATABASE_URL`/`MYSQL_URL` или `DB_*`, что и на Railway (взять из панели Railway), затем:
  ```bash
  node backend/run-migrations.js
  ```
- **Вариант Б:** в Railway добавить одноразовый **job** или временный сервис с командой `node backend/run-migrations.js` и теми же переменными БД.

Схему таблиц можно применить так же, подключившись к MySQL по данным из Railway (например через GUI-клиент или `mysql` с хоста Railway).

### Кратко по Railway

| Шаг | Действие |
|-----|-----------|
| 1 | New Project → Deploy from GitHub (ваш репо) |
| 2 | + New → Database → Add MySQL |
| 3 | У сервиса приложения: Build = `npm run build`, Start = `npm start` |
| 4 | Переменные БД подставятся автоматически или задать `DB_*` / `DATABASE_URL` |
| 5 | Generate Domain в Networking |
| 6 | Один раз выполнить миграции (локально с теми же данными БД или job в Railway) |

Деплой = push в Git. Railway сам пересоберёт и перезапустит приложение.

---

## Переменные окружения (backend)

Скопируйте `backend/.env.example` в `backend/.env` и заполните:

| Переменная   | Описание        |
|-------------|-----------------|
| `DB_HOST`   | Хост MySQL      |
| `DB_PORT`   | Порт MySQL      |
| `DB_USER`   | Пользователь БД |
| `DB_PASSWORD` | Пароль БД     |
| `DB_NAME`   | Имя базы        |
| `DATABASE_URL` или `MYSQL_URL` | Одна строка подключения (Railway и др.): `mysql://user:password@host:port/database` |
| `PORT`      | Порт приложения (по умолчанию 3000; Railway задаёт сам) |
| `NODE_ENV`  | `production` при деплое |

Для продакшена фронтенд собирается с `VITE_API_URL=/api` (уже заложено в скрипт и Dockerfile), чтобы запросы шли на тот же домен/порт, что и сайт.

---

## Недорогой хостинг + домен в подарок

Варианты, где можно разместить приложение (Node.js + MySQL) и часто бывает **домен в подарок** или со скидкой. Цены и акции уточняйте на сайтах.

| Провайдер | Что даёт | Домен в подарок | Цены (ориентир) |
|-----------|----------|------------------|------------------|
| **Timeweb Cloud** | VPS, образы Node.js и Docker, MySQL отдельно или свой | При покупке домена — 1 мес хостинга в подарок; домены .ru от ~179 ₽/год | VPS от ~188 ₽/мес |
| **Reg.ru (Reg Cloud)** | VPS с Node.js (Ubuntu), почасовая оплата | Промокоды на бесплатное продление .ru/.рф при продлении хостинга на 12+ мес | VPS от ~149 ₽/мес, домен .ru ~179 ₽/год |
| **Spaceweb (sweb.ru)** | VPS, поддержка Node.js | Бесплатный домен при оплате хостинга на 6 или 12 мес (акция до 2026) | VPS от ~9,57 ₽/день |
| **Beget** | VPS с root, можно поставить Node.js и MySQL | Бесплатный домен при оплате хостинга на год (бонусные домены в разных зонах) | Уточнять на beget.com |
| **Castle Host** | Веб-хостинг с Node.js | Бесплатный домен на всех тарифах | От 99 ₽/мес |
| **UltaHost** | Управляемый VPS с Node.js | Бесплатный домен при оплате на год | От ~$4.80/мес |

**Что проверить перед заказом:**  
- Есть ли на тарифе **Node.js** или возможность установить его (root/SSH).  
- Есть ли **MySQL** (отдельный сервер, образ в маркетплейсе или управляемая БД).  
- Условия акции «домен в подарок» (первый год, только при годовой оплате и т.д.).

**Итог:** дешёвый вариант с доменом — часто **оплата хостинга/VPS на 6–12 месяцев** + акция на бесплатный домен (.ru, .рф и др.). Для нашего стека нужен именно VPS или облако с Node.js, а не обычный виртуальный хостинг.

---

## Международный хостинг (не только РФ)

Если регион не важен, можно взять **дешёвый VPS или PaaS за рубежом** — часто выгоднее и с бесплатным доменом/поддоменом.

### VPS с Node.js и доменом

| Провайдер | Что даёт | Домен / поддомен | Цены (ориентир) |
|-----------|----------|-------------------|-----------------|
| **Hostinger** | VPS с предустановленным Node.js (Ubuntu) | **Бесплатный домен .cloud на 1 год** на всех тарифах | От ~$4.99/мес |
| **Hetzner** | VPS (EU/US/SG), ставишь Node.js сам | Домен покупается отдельно (~€10/год и т.д.) | От ~€3.49–3.79/мес |
| **DigitalOcean** | Droplets + App Platform для Node.js | Домен отдельно или бесплатный поддомен *.ondigitalocean.app | От $4/мес |
| **Vultr** | VPS по всему миру | Домен отдельно | От ~$6/мес |
| **UltaHost** | Управляемый VPS с Node.js | Бесплатный домен при оплате на год | От ~$4.80/мес |

### PaaS (деплой из Git, без своего сервера)

| Провайдер | Что даёт | Домен | Цены |
|-----------|----------|--------|------|
| **Railway** | Node.js + MySQL в одном месте, деплой из GitHub | Бесплатный поддомен *.railway.app | Бесплатный план: $1 кредитов/мес; платно от использования |
| **Render** | Node.js + БД, деплой из Git | Бесплатный поддомен *.onrender.com | Есть free tier (условия на сайте) |
| **Fly.io** | Контейнеры по миру, Node.js + MySQL | Бесплатный поддомен *.fly.dev | Pay-as-you-go, есть бесплатные лимиты |
| **Vercel** | Фронт + Serverless/Edge; бэкенд лучше вынести на Railway/Render | Бесплатный поддомен *.vercel.app | Free tier для фронта |

**Практичный вариант за рубежом:**  
- **Hostinger** — если нужен именно **домен в подарок** (.cloud на год) + VPS с Node.js.  
- **Hetzner** — если важна **низкая цена** (от ~€3.49/мес), домен докупаешь где угодно (.com от ~$10/год).  
- **Railway** — если хочешь **без своего сервера**: подключил Git, настроил переменные БД, получил поддомен *.railway.app (свой домен можно привязать позже).

Цены и условия уточняйте на сайтах провайдеров.

---

## Кратко

| Способ | Нужен ли npm на сервере? | Что делаете вы |
|--------|---------------------------|----------------|
| **Docker** | Нет | `docker build` у себя, на сервере только `docker run` |
| **Один сервер (Node)** | Только `npm install` один раз | Сборка скриптом у себя, заливка `backend` + запуск `node server.js` |
| **PaaS** | Нет (всё делает хостинг) | Подключить Git, задать build/start и переменные БД |

Во всех вариантах можно обойтись **без ручного запуска npm для сборки** на хостинге; в варианте с Docker — вообще без установки Node/npm на сервере.
